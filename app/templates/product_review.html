{% block content %}

{% if current_user %}
  <!-- Display All Product Reviews in a Table -->
  {% if product_reviews %}
    <h2>Product Reviews</h2>
    <!-- Add a New Review -->
    <button class="openPopup" onClick = "newProductReview(this)">New Review</button>

    <!-- Popup Form, initially hidden -->
    <div class="popup-container" style="display: none;" id="newProductPopup">
        <form class="inputForm" action="{{ url_for('myreview.new_product_review', pr_userkey=review.pr_userkey, pr_productkey=review.pr_productkey) }}" method="POST">
            <label>Enter New Product Review:</label>
            <input type="text" id="userInput" name="userInput" required>

            <label for="userRating">Rating (1-5):</label>
            <select id="userRating" name="userRating">
                <option value="1">1</option>
                <option value="2">2</option>
                <option value="3">3</option>
                <option value="4">4</option>
                <option value="5">5</option>
            </select>

            <button type="submit" onsubmit="handleSubmit(event, 'newProductPopup')" class="submitBtn">Submit</button>
        </form>
    </div>

    <table class="table">
      <thead>
        <tr>
          <th>Review Date</th>
          <th>Review</th>
          <th>Rating</th>
        </tr>
      </thead>
      <tbody>
        {% for review in product_reviews %}
          <tr>
            <td>{{ review.pr_reviewdate }}</td>
            <td>{{ review.pr_review }}</td>
            <td>{{ review.pr_rating }}</td>
          </tr>
        {% endfor %}
      </tbody>
    </table>
  {% endif %}

{% else %}
  <h2>Please log in to view reviews.</h2>
  <!-- You can add a login link or button here -->
  <!-- <a href="/login" class="btn btn-primary">Login</a> -->
{% endif %}

<script>
  window.newProductReview = function(element) {
    var popup = document.getElementById("newProductPopup");
    if (popup) {
        popup.style.display = 'block';
    } else {
        console.error("Popup element not found");
    }
  };

  function handleSubmit(event, popupId) {
    event.preventDefault(); // Prevent default form submission
    var form = event.target;
    var url = form.action;
    
    fetch(url, {
        method: 'POST',
        body: new FormData(form),
        headers: {
            'Accept': 'application/json',
        }
    }).then(response => {
        document.getElementById(popupId).style.display = 'none'; // Close the popup
        if (response.ok) {
            return response.json(); // Or handle any other way
        }
        throw new Error('Something went wrong on api server!');
    }).then(response => {
        console.log(response);
        alert('Review successfully added or updated.');
    }).catch(error => {
        console.error(error);
    });
  }
</script>

{% endblock %}
